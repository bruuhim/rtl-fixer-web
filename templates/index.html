<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>RTL Subtitle Fixer</title>
    <meta name="description" content="Instantly fix right-to-left (RTL) text issues in your .ASS and .SRT subtitle files.">
    <meta property="og:title" content="RTL Subtitle Fixer">
    <meta property="og:description" content="Upload your subtitle files and fix RTL text issues instantly.">
    <meta name="theme-color" content="#667eea">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- NEW: CSS Variables for Theming --- */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: rgba(255, 255, 255, 0.95);
            --text-title: #334155;
            --text-body: #64748b;
            --border-color: rgba(255, 255, 255, 0.2);
            --dashed-border-color: #cbd5e1;
            --upload-area-bg: rgba(248, 250, 252, 0.5);
            --file-item-bg: rgba(248, 250, 252, 0.8);
            --footer-border-color: #e2e8f0;
        }

        html.dark-mode {
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #475569;
            --container-bg: rgba(30, 41, 59, 0.95);
            --text-title: #f1f5f9;
            --text-body: #94a3b8;
            --border-color: rgba(71, 85, 105, 0.5);
            --dashed-border-color: #475569;
            --upload-area-bg: rgba(51, 65, 85, 0.5);
            --file-item-bg: rgba(51, 65, 85, 0.8);
            --footer-border-color: #334155;
        }
        /* --- End Theming --- */

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; overflow-x: hidden; transition: font-family 0.3s ease, background 0.3s ease; }
        html[dir="rtl"] body { font-family: 'Tajawal', sans-serif; }
        .lang-ar, html[lang="ar"] .lang-en { display: none; }
        html[lang="ar"] .lang-ar { display: inline; }
        .settings-container { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 20px; }
        .lang-switch-container, .theme-switch-container { display: flex; align-items: center; gap: 10px; color: white; font-size: 0.9rem; }
        .lang-switch, .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .lang-switch input, .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #667eea; }
        input:checked + .slider:before { transform: translateX(24px); }
        .background-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; background-image: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.2) 2px, transparent 2px), radial-gradient(circle at 75% 75%, rgba(255,255,255,0.2) 2px, transparent 2px); background-size: 60px 60px; animation: float 20s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(1deg); } }
        .container { background: var(--container-bg); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); padding: 40px; width: 100%; max-width: 600px; position: relative; z-index: 1; border: 1px solid var(--border-color); transition: background 0.3s ease, border 0.3s ease; }
        .header { text-align: center; margin-bottom: 40px; }
        .title { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; line-height: 1.2; }
        .subtitle { color: var(--text-body); font-size: 1.1rem; font-weight: 500; }
        .upload-area { border: 2px dashed var(--dashed-border-color); border-radius: 16px; padding: 60px 20px; text-align: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: var(--upload-area-bg); position: relative; overflow: hidden; cursor: pointer; }
        .upload-area:hover, .upload-area:focus { outline: none; border-color: #667eea; background: rgba(102, 126, 234, 0.05); transform: translateY(-2px); }
        .upload-text { color: var(--text-title); }
        .upload-subtext { color: var(--text-body); }
        .file-list { margin-top: 30px; display: none; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--file-item-bg); border-radius: 12px; margin-bottom: 12px; border: 1px solid rgba(226, 232, 240, 0.1); transition: all 0.3s ease; }
        html[dir="rtl"] .file-item { text-align: right; }
        .file-name { color: var(--text-title); }
        .file-size { color: var(--text-body); }
        .footer-credit { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--footer-border-color); font-size: 0.9rem; color: var(--text-body); }
        .footer-credit a { color: var(--text-body); font-weight: 600; text-decoration: none; transition: color 0.2s ease; }
        .footer-credit a:hover { color: var(--text-title); text-decoration: underline; }
        /* A few unchanged styles for brevity */
        .upload-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .browse-button { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; font-size: 0.95rem; }
        .remove-button { background: #ef4444; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .process-button { width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; display: none; }
        .process-button:disabled { background: #9ca3af; cursor: not-allowed; }
        .progress-bar { width: 100%; height: 8px; background: rgba(226, 232, 240, 0.8); border-radius: 4px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #10b981, #059669); width: 0%; transition: width 0.3s ease; border-radius: 4px; }
        .status-message { text-align: center; margin-top: 16px; font-weight: 500; display: none; }
        .success { color: #059669; } .error { color: #dc2626; } .processing { color: #667eea; }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="settings-container">
        <div class="lang-switch-container">
            <span class="lang-en">EN</span>
            <span class="lang-ar">AR</span>
            <label class="lang-switch">
                <input type="checkbox" id="languageToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="theme-switch-container">
            ☀️
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider"></span>
            </label>
            🌙
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 class="title"><span class="lang-en">RTL Subtitle Fixer</span><span class="lang-ar">مُصلح ملفات الترجمة</span></h1>
            <p class="subtitle"><span class="lang-en">Upload your subtitle files and fix RTL text issues instantly</span><span class="lang-ar">ارفع ملفات الترجمة وأصلح مشاكل اتجاه النص فوراً</span></p>
        </div>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="upload-area" id="uploadArea" role="button" tabindex="0">
                <div class="upload-icon"><svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                <div class="upload-text"><span class="lang-en">Drop your ASS or SRT files here</span><span class="lang-ar">اسحب ملفات ASS أو SRT إلى هنا</span></div>
                <div class="upload-subtext"><span class="lang-en">or click to browse and select multiple files</span><span class="lang-ar">أو انقر للاستعراض وتحديد عدة ملفات</span></div>
                <button type="button" class="browse-button" id="browseButton"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg><span class="lang-en">Browse Files</span><span class="lang-ar">استعراض الملفات</span></button>
                <input type="file" id="fileInput" name="files" multiple accept=".ass,.srt" class="file-input">
            </div>
            <div class="file-list" id="fileList"></div>
            <button type="submit" class="process-button" id="processButton"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg><span class="lang-en">Process Files</span><span class="lang-ar">معالجة الملفات</span></button>
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="status-message" id="statusMessage"></div>
        </form>
        <div class="footer-credit"><span class="lang-en">Designed By</span><span class="lang-ar">تصميم</span> <a href="https://x.com/bruuhim" target="_blank" rel="noopener noreferrer">@bruuhim</a></div>
    </div>

    <script>
        const translations = { /* Same translations object */ };
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        /* ... other const declarations ... */
        const languageToggle = document.getElementById('languageToggle');
        const themeToggle = document.getElementById('themeToggle'); // NEW
        
        let selectedFiles = [];
        let currentLang = 'en';

        // --- NEW: Theme Switch Logic ---
        function setTheme(theme) {
            document.documentElement.classList.toggle('dark-mode', theme === 'dark');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#1e293b' : '#667eea');
            localStorage.setItem('theme', theme);
            themeToggle.checked = theme === 'dark';
        }

        themeToggle.addEventListener('change', (e) => {
            setTheme(e.target.checked ? 'dark' : 'light');
        });

        // --- Language Switch Logic ---
        function setLanguage(lang) { /* Same as before */ }
        languageToggle.addEventListener('change', (e) => { setLanguage(e.target.checked ? 'ar' : 'en'); });

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Language
            const savedLang = localStorage.getItem('language') || 'en';
            setLanguage(savedLang);

            // Theme
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) {
                setTheme(savedTheme);
            } else if (prefersDark) {
                setTheme('dark');
            }
        });

        // --- All other functions (addFiles, renderFileList, handleFormSubmit, etc.) ---
        
        // Minor change in handleFormSubmit to get correct single-file download name
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (selectedFiles.length === 0) { showStatus(translations.error_process[currentLang], 'error'); return; }
            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files', file));
            
            // ... all the setup logic ...
            
            try {
                const response = await fetch('/', { method: 'POST', body: formData });
                progressFill.style.width = '100%';
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // NEW: Get the filename from the server for single file downloads
                    const disposition = response.headers.get('Content-Disposition');
                    let downloadName = 'fixed_files.zip'; // Default for multi-file
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            downloadName = matches[1].replace(/['"]/g, '');
                        }
                    }
                    a.download = downloadName;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus(translations.status_success[currentLang], 'success');
                    setTimeout(() => { /* reset form */ }, 4000);
                } else {
                    // ... error handling ...
                }
            } catch (error) {
                // ... error handling ...
            } finally {
                processButton.disabled = false;
            }
        }
        
        // The rest of the JS functions are unchanged.
        // For brevity, I'm omitting the full code for functions that are identical to the previous version.
        // Full code is available in the complete file block above.
        
    </script>
</body>
</html>
